var CjBlogAdminFactory = {};

(function($){
	CjBlogAdminFactory.init = function(){
		$('.tooltip-hover').tooltip();
		$(".collapse").collapse();
		$('body').on('mouseover', '[data-toggle="tooltip"]', function(){$(this).tooltip('show');});
	};
	
	CjBlogAdminFactory.init_points_form = function(){
		$('form[name="adminForm"]').submit(function(){
			$('#target_names').find('option').attr('selected', true);
		});
		var input = $('#username');
		input.keyup(function(e){
			if(input.val().length > 1 && 
					(e.which == 32 || 
					(e.which >= 48 && e.which <= 57) || 
					(e.which >= 97 && e.which <= 122) || 
					(e.which >= 65 && e.which <= 90))){
				$.ajax({
					url: $('#url-get-usernames').text(),
					data: {'search': input.val()},
					dataType: 'json',
					success: function(data, statusText, xhr, form){
						if(data.data != null){
							$('#source_names').find('option').remove();
							$.each(data.data, function(index, user){
								console.log(user);
								$('#source_names').append($('<option>', {value: user.id}).html(user.username+' ('+user.name+')'));
							});
						}
					}
				});
			}
		});
		$('.to_right').click(function(){$('#source_names option:selected').appendTo($('#target_names'));});
		$('.to_left').click(function(){$('#target_names option:selected').appendTo($('#source_names'));});
		$('.all_right').click(function(){$('#source_names option').appendTo($('#target_names'));});
		$('.all_left').click(function(){$('#target_names option').appendTo($('#source_names'));});
	};
	
	CjBlogAdminFactory.init_points_rules_form = function()
	{
		$('.btn-add-condition').click(function(){
			var condition = $('.conditional_rules tr:first').clone();
			condition.find('input:last').val('0');
			$('.conditional_rules').append(condition);
		});
		$('.conditional_rules').on('click', '.btn-delete-condition', function(){
			$(this).closest('tr').remove();
		});
	}
	
	CjBlogAdminFactory.init_badge_trigger_form = function()
	{
		$('#inputRuleId').change(function(){
			var selectedRule = null;
			var selectedRuleId = $(this).val();
			$.each(badge_rules, function(index, rule){
				if(rule.id == selectedRuleId){
					selectedRule = rule;
					return true;
				}
			});
			
			if(selectedRule){
				$('#ruleParams').empty().append($('<p>').html(selectedRule.description));
				if(selectedRule.content.rules){
					$.each(selectedRule.content.rules, function(index, rule){
						var html = $('<div>', {'class': 'control-group'});
						html.append(
							$('<label>', {'class': 'control-label', 'for': rule.name}).html(rule.name),
							$('<div>', {'class': 'controls'}).append($('<input>', {'type': 'text', 'name': rule.name, 'id': rule.name}))
						);
						$('#ruleParams').append(html);
					});
				}
			}
		});
	};
})(jQuery);

jQuery(document).ready(function($){
	CjBlogAdminFactory.init();
	var pageid = $('#cjblog_page_id').val();
	if(pageid == 'points_form') CjBlogAdminFactory.init_points_form();
	if(pageid == 'points_rules_form') CjBlogAdminFactory.init_points_rules_form();
	if(pageid == 'badge_trigger_form') CjBlogAdminFactory.init_badge_trigger_form();
});